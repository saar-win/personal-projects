name: build-and-deploy-eks
on:
  pull_request:
        paths:
          - 'reali.com/**'
        branches:
          - main
jobs:
  BUILD:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: Get into reali dir
        run: cd reali.com
      - name: Build & push Docker image
        uses: mr-smithers-excellent/docker-build-push@v5
        with:
          image: wintrov/reali
          tags: latest
          registry: docker.io
          dockerfile: app/Dockerfile
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

          
  DEPLOY:
    runs-on: ubuntu-latest
    needs:
      - BUILD
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: change dir
        run: |
          cd reali.com
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Trigger deploy
        uses: Consensys/kubernetes-action@master
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        with:
          args: apply ops/
